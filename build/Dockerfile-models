FROM --platform=${BUILDPLATFORM} python:3.11-slim AS downloader
ENV PYTHONUNBUFFERED=1

WORKDIR /app

# Define whether to use ModelScope or Hugging Face models.
# This can be overridden at build time via --build-arg USE_MODELSCOPE=1
ARG USE_MODELSCOPE="0"
ENV USE_MODELSCOPE=${USE_MODELSCOPE}

# Define the target directory for Hugging Face models/cache.
# This can be overridden at build time via --build-arg MODELS_CACHE_PATH=...
ARG MODELS_CACHE_PATH="/models_cache"
ENV HF_HOME=${MODELS_CACHE_PATH} \
    HUGGINGFACE_HUB_CACHE=${MODELS_CACHE_PATH} \
    MODELSCOPE_CACHE=${MODELS_CACHE_PATH}
RUN mkdir -p ${HF_HOME} # Ensure the cache directory exists

RUN pip install --no-cache-dir huggingface_hub modelscope
COPY scripts/prepare_for_mineru.py ./scripts/prepare_for_mineru.py
RUN python ./scripts/prepare_for_mineru.py

FROM scratch
COPY --from=downloader /models_cache /models_cache
COPY --from=downloader /app/magic-pdf*.json /mineru/
