FROM python:3.11-slim AS downloader
ENV PYTHONUNBUFFERED=1

# Install uv globally
# uv will be used in the final stage to install project dependencies.
RUN pip install --no-cache-dir uv

WORKDIR /app

# Copy the pyproject.toml and uv.lock (if it exists) first
# This allows Docker to leverage caching for dependencies if they haven't changed
COPY pyproject.toml ./
COPY uv.lock ./

# Install dependencies using uv
# --no-cache to reduce image size
RUN uv sync --no-cache --prerelease=allow

FROM scratch
COPY --from=downloader /app/.venv /venv
